name: CD Production

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version à déployer"
        required: true
        default: "latest"

permissions:
  contents: read

jobs:
  ci-backend:
    name: CI Backend
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: backend

    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Configuration de Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: backend/package-lock.json

      - name: Installation des dépendances
        run: npm ci

      - name: Audit de sécurité
        run: npm audit --audit-level=high

      - name: Linting ESLint
        run: npm run lint

      - name: Tests Jest
        run: npm run test:ci
        env:
          NODE_ENV: test

      - name: Upload couverture backend
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage
          path: backend/coverage/
          retention-days: 30

  ci-frontend:
    name: CI Frontend
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: frontend

    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Configuration de Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Installation des dépendances
        run: npm ci

      - name: Audit de sécurité
        run: npm audit --audit-level=high

      - name: Linting ESLint
        run: npm run lint

      - name: Type-check
        run: npm run type-check

  e2e-tests:
    name: E2E - ${{ matrix.browser }}
    runs-on: ubuntu-latest
    needs: [ci-backend, ci-frontend]

    strategy:
      fail-fast: false
      matrix:
        browser: [chrome, firefox, edge]

    defaults:
      run:
        working-directory: frontend

    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Configuration de Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: |
            frontend/package-lock.json
            backend/package-lock.json

      - name: Installation des dépendances frontend
        run: npm ci

      - name: Installation des dépendances backend
        working-directory: backend
        run: npm ci

      - name: Build du frontend
        run: npm run build-only

      - name: Démarrage du backend
        working-directory: backend
        run: |
          npm run start:e2e &
          sleep 5
        env:
          NODE_ENV: test
          PORT: 3000

      - name: Tests Cypress - ${{ matrix.browser }}
        uses: cypress-io/github-action@v6
        with:
          working-directory: frontend
          start: npm run preview -- --port 4173
          wait-on: "http://localhost:4173, http://localhost:3000"
          wait-on-timeout: 120
          browser: ${{ matrix.browser }}
          config: baseUrl=http://localhost:4173
        env:
          CYPRESS_BACKEND_URL: http://localhost:3000

      - name: Upload screenshots
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: cypress-screenshots-prod-${{ matrix.browser }}
          path: frontend/cypress/screenshots/
          retention-days: 7

      - name: Upload vidéos
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: cypress-videos-prod-${{ matrix.browser }}
          path: frontend/cypress/videos/
          retention-days: 7

  build:
    name: Build Production
    runs-on: ubuntu-latest
    needs: [e2e-tests]

    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Configuration de Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Installation des dépendances frontend
        working-directory: frontend
        run: npm ci

      - name: Build du frontend (production)
        working-directory: frontend
        run: npm run build-only
        env:
          NODE_ENV: production

      - name: Upload du build frontend
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist-prod
          path: frontend/dist/
          retention-days: 7

      - name: Upload du backend
        uses: actions/upload-artifact@v4
        with:
          name: backend-code-prod
          path: |
            backend/
            !backend/node_modules/
          retention-days: 7

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [build]

    environment:
      name: production
      url: http://${{ secrets.PROD_SSH_HOST }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Artifacts (frontend build)
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist-prod
          path: ./dist

      - name: Download Artifacts (backend)
        uses: actions/download-artifact@v4
        with:
          name: backend-code-prod
          path: ./backend

      - name: Prepare app directory permissions
        uses: appleboy/ssh-action@v0.1.9
        with:
          host: ${{ secrets.PROD_SSH_HOST }}
          username: ${{ secrets.PROD_SSH_USER }}
          key: ${{ secrets.PROD_SSH_PRIVATE_KEY }}
          port: 22
          script: |
            sudo mkdir -p /var/www/todo-app/dist
            sudo mkdir -p /var/www/todo-app/backend
            sudo chown -R ${USER}:${USER} /var/www/todo-app
            sudo chmod -R 755 /var/www/todo-app

      - name: Remove FRONTEND
        uses: appleboy/ssh-action@v0.1.9
        with:
          host: ${{ secrets.PROD_SSH_HOST }}
          username: ${{ secrets.PROD_SSH_USER }}
          key: ${{ secrets.PROD_SSH_PRIVATE_KEY }}
          port: 22
          script: |
            sudo rm -rf /var/www/todo-app/dist
            sudo mkdir -p /var/www/todo-app/dist
            sudo chown -R ${USER}:${USER} /var/www/todo-app/dist

      - name: Copy files to Server (dist)
        uses: appleboy/scp-action@v1
        with:
          host: ${{ secrets.PROD_SSH_HOST }}
          username: ${{ secrets.PROD_SSH_USER }}
          key: ${{ secrets.PROD_SSH_PRIVATE_KEY }}
          source: "./dist/*"
          target: "/var/www/todo-app/dist"

      - name: Copy files to Server (backend)
        uses: appleboy/scp-action@v1
        with:
          host: ${{ secrets.PROD_SSH_HOST }}
          username: ${{ secrets.PROD_SSH_USER }}
          key: ${{ secrets.PROD_SSH_PRIVATE_KEY }}
          source: "./backend/*"
          target: "/var/www/todo-app/backend"

      - name: Deploy App via SSH
        uses: appleboy/ssh-action@v0.1.9
        with:
          host: ${{ secrets.PROD_SSH_HOST }}
          username: ${{ secrets.PROD_SSH_USER }}
          key: ${{ secrets.PROD_SSH_PRIVATE_KEY }}
          port: 22
          script: |
            cd /var/www/todo-app
            sudo npm install pm2 -g

            # docker compose up (si un docker-compose.yml est présent côté serveur)
            if [ -f docker-compose.yml ] || [ -f docker-compose.yaml ]; then
              docker compose up -d
            fi

            # env
            rm -f ./backend/.env
            echo "DB_URL=${{ secrets.PROD_DB_URL }}" >> ./backend/.env

            # start backend
            cd ./backend
            npm install --omit=dev
            pm2 reload ecosystem.config.js --env production || pm2 start ecosystem.config.js --env production
            pm2 save

      - name: Vérification du déploiement
        run: |
          sleep 15
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.PROD_SSH_HOST }} || echo "000")
          echo "HTTP=$HTTP_CODE"

  notify:
    name: Notification
    runs-on: ubuntu-latest
    needs: [deploy-production]
    if: always()

    steps:
      - name: Résumé du déploiement
        run: |
          echo "================================================"
          echo "Version: ${{ github.event.inputs.version }}"
          echo "Date: $(date)"
          echo "Déclenché par: ${{ github.actor }}"
          echo "Commit: ${{ github.sha }}"
          echo "Statut: ${{ needs.deploy-production.result }}"
          echo "================================================"
